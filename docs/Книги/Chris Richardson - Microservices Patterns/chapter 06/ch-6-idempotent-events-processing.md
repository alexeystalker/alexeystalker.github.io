---
share: true
tags:
 - event-sourcing
---
# Идемпотентная обработка сообщений
Сервисы часто потребляют сообщения из других приложений или сервисов. Как описывалось [[ch-3-message-duplicates|в главе 3]], при разработке потребителя сообщений важно убедиться в его идемпотентности, поскольку брокер может доставить сообщение более чем один раз.
Потребитель является идемпотентным, если его можно безопасно вызывать по нескольку раз с одним и тем же сообщением.
## Идемпотентная обработка сообщений с хранилищем событий на основе реляционной БД
Можно применить подход, аналогичный описанному в шаблоне [[idempotent-consumer-pattern|идемпотентный потребитель]] — записывать ID сообщения в таблицу `PROCESSED_MESSAGES` в рамках транзакции, которая добавляет события в таблицу `EVENTS`
## Идемпотентная обработка сообщений с хранилищем событий на основе NoSQL
На время обработки сообщения потребитель хранит его идентификатор внутри генерируемых событий. Для обнаружения дубликатов он следит за тем, чтобы ни одно из событий агрегата не содержало ID сообщения.
Как следствие все сообщения должны порождать события, пусть даже это будет псевдособытие, не меняющее состояния агрегата и хранящее только ID сообщения.