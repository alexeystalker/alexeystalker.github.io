---
tags: [Elasticsearch/aggs]
share: true
---
# Filter Aggregation
“Однокорзинная” агрегация, которая собирает в корзину документы, соответствующие фильтру. Примерно так:
```json
{
    "aggs": {
        "with_filter": {
            "filter": {
        		"bool": {
        			"filter": [
        				{
        					"terms": {
        						"status-tags": [
        							"active",
        							"not-so-active",
        							"unknown"
        						]
        					}
        				},
        				{
        					"range": {
        						"user-reg-date": {
        							"gte": "00010101",
        							"lte": "20210729"
        						}
        					}
        				}
        			]
        		}
            }
        }
    }
}
```
Разберем пример. Сначала идёт ключевое слово `"aggs"`, определяет собственно начало описания агрегации. Дальше вложено _имя_ агрегации, оно НЕ ключевое, и объект. Внутри — _тип агрегации_ `"filter"`, далее объект фильтра. В объект фильтра можно сложить  _весь_ объект запроса, который в обычном поиске идет под ключом `"query"`. После фильтра добавляем вложеную агрегацию:
```json
{
	"aggs": {
		"t_shirts": {
			"filter": {
				"term": {
					"type": "t-shirt"
				}
			},
			"aggs": {
				"avg_price": {
					"avg": {
						"field": "price"
					}
				}
			}
		}
	}
}
```
По идее, все агрегации над фильтрованными данными будут вложенными к этой, либо, если она вложенная — применяем фильтр к содержимому каждой корзины внешней агрегации.
Есть альтернатива — добавить агрегации к запросу `query`, если в нем есть фильтры (`filter`). Эти же фильтры будут применены к документам, над которыми будет проводиться аггрегация
## Ссылки
https://www.elastic.co/guide/en/elasticsearch/reference/7.8/search-aggregations-bucket-filter-aggregation.html
